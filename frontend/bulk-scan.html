<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk URL Scanner - WebShield</title>
    <style>
        :root {
            --background: 220 40% 8%;
            --foreground: 220 15% 96%;
            --primary: 220 90% 56%;
            --accent: 160 84% 45%;
            --muted: 220 20% 12%;
            --border: 220 20% 18%;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(125deg, 
                    hsl(220 40% 8%) 0%, 
                    hsl(230 45% 12%) 20%, 
                    hsl(240 40% 10%) 40%, 
                    hsl(250 45% 12%) 60%, 
                    hsl(260 40% 10%) 80%, 
                    hsl(220 40% 8%) 100%),
                radial-gradient(ellipse at top left, hsl(220 90% 56% / 0.15) 0%, transparent 40%),
                radial-gradient(ellipse at bottom right, hsl(280 80% 50% / 0.12) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }
        
        .bulk-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            position: relative;
            z-index: 1;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .textarea-container {
            margin: 20px 0;
        }
        
        .url-textarea {
            width: 100%;
            min-height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .url-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
        }
        
        .file-upload input {
            display: none;
        }
        
        .scan-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-scan {
            background: linear-gradient(135deg, 
                hsl(160 84% 45%) 0%, 
                hsl(160 80% 50%) 50%, 
                hsl(160 84% 55%) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px 0 hsl(var(--accent) / 0.25);
            position: relative;
            overflow: hidden;
        }
        
        .btn-scan::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-scan:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px 0 hsl(var(--accent) / 0.4);
        }
        
        .btn-scan:hover::before {
            left: 100%;
        }
        
        .btn-secondary {
            background: hsl(var(--muted));
            color: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: hsl(var(--muted) / 0.8);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, hsl(142 76% 40%), hsl(142 76% 36%));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 hsl(142 76% 40% / 0.25);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 hsl(142 76% 40% / 0.4);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 242, 254, 0.3);
        }
        
        .result-card.safe {
            border-left: 4px solid #4CAF50;
        }
        
        .result-card.threat {
            border-left: 4px solid #F44336;
        }
        
        .result-card.scanning {
            border-left: 4px solid #FFC107;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f2fe, #4facfe);
            transition: width 0.3s ease;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            gap: 20px;
        }
        
        .stat-box {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h1, h2, h3 {
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--accent)));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .back-button {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(220 85% 60%));
            color: white;
            text-decoration: none;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 hsl(var(--primary) / 0.25);
            border: none;
            cursor: pointer;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 hsl(var(--primary) / 0.4);
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="bulk-container">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 3rem; margin-bottom: 1rem;">üîç Bulk URL Scanner</h1>
            <p style="color: hsl(var(--muted-foreground)); font-size: 1.125rem; margin-bottom: 20px;">
                Scan multiple URLs simultaneously with AI-powered threat detection
            </p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="dashboard.html" class="back-button">‚Üê Back to Dashboard</a>
                <a href="index.html" class="back-button" style="background: linear-gradient(135deg, hsl(var(--accent)), hsl(160 80% 50%));">üè† Home</a>
                <button class="back-button" onclick="loadSampleUrls()" style="background: linear-gradient(135deg, #FF9800, #f57c00);">
                    üìã Load Sample URLs
                </button>
            </div>
        </div>
        
        <div class="upload-section">
            <h2>üìù Enter URLs</h2>
            <div class="textarea-container">
                <textarea 
                    class="url-textarea" 
                    id="url-input"
                    placeholder="Enter URLs (one per line)&#10;Example:&#10;https://example.com&#10;https://google.com&#10;https://suspicious-site.tk"></textarea>
            </div>
            
            <div class="file-upload" onclick="document.getElementById('file-input').click()">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                <h3>Or Upload CSV/TXT File</h3>
                <p style="color: rgba(255, 255, 255, 0.6);">Click to browse or drag and drop</p>
                <input type="file" id="file-input" accept=".csv,.txt" onchange="handleFileUpload(event)">
            </div>
            
            <div class="scan-controls">
                <button class="btn-scan" onclick="startBulkScan()">
                    <span style="margin-right: 8px;">üöÄ</span> Start Bulk Scan
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    <span style="margin-right: 8px;">üóëÔ∏è</span> Clear All
                </button>
                <button class="btn-success" onclick="exportResults()">
                    <span style="margin-right: 8px;">üì•</span> Export Results
                </button>
            </div>
        </div>
        
        <div id="progress-section" style="display: none;">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-number" id="total-urls">0</div>
                    <div class="stat-label">Total URLs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="scanned-urls">0</div>
                    <div class="stat-label">Scanned</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="safe-urls">0</div>
                    <div class="stat-label">Safe</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="threat-urls">0</div>
                    <div class="stat-label">Threats</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="results-grid" id="results-grid"></div>
    </div>
    
    <script>
        let scanResults = [];
        let totalUrls = 0;
        let scannedUrls = 0;
        let safeUrls = 0;
        let threatUrls = 0;
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const urls = content.split(/[\n,]/).map(url => url.trim()).filter(url => url);
                document.getElementById('url-input').value = urls.join('\n');
            };
            reader.readAsText(file);
        }
        
        async function startBulkScan() {
            const input = document.getElementById('url-input').value;
            let urls = input.split('\n').map(url => url.trim()).filter(url => url);
            
            if (urls.length === 0) {
                showNotification('Please enter at least one URL', 'error');
                return;
            }
            
            // Validate and clean URLs
            urls = urls.map(url => {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    return 'https://' + url;
                }
                return url;
            }).filter(url => {
                try {
                    new URL(url);
                    return true;
                } catch {
                    return false;
                }
            });
            
            if (urls.length === 0) {
                showNotification('No valid URLs found', 'error');
                return;
            }
            
            // Reset counters
            scanResults = [];
            totalUrls = urls.length;
            scannedUrls = 0;
            safeUrls = 0;
            threatUrls = 0;
            
            // Show progress section
            document.getElementById('progress-section').style.display = 'block';
            updateStats();
            
            // Clear previous results
            document.getElementById('results-grid').innerHTML = '';
            
            // Disable scan button during processing
            const scanBtn = document.querySelector('.btn-scan');
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<span style="margin-right: 8px;">‚è≥</span> Scanning...';
            
            console.log(`üöÄ Starting bulk scan of ${urls.length} URLs`);
            
            // Conservative batch size to prevent resource exhaustion
            const batchSize = Math.min(5, Math.max(2, Math.ceil(urls.length / 8))); // Smaller batches
            const startTime = Date.now();
            
            // Add resource monitoring
            let activeScans = 0;
            const maxConcurrentScans = 5;
            
            try {
                for (let i = 0; i < urls.length; i += batchSize) {
                    const batch = urls.slice(i, i + batchSize);
                    console.log(`üì¶ Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(urls.length/batchSize)} (${batch.length} URLs)`);
                    
                    // Process batch with resource control
                    const batchPromises = batch.map(async (url) => {
                        // Wait for available slot
                        while (activeScans >= maxConcurrentScans) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        activeScans++;
                        
                        try {
                            return await scanSingleUrlOptimized(url);
                        } finally {
                            activeScans--;
                        }
                    });
                    
                    await Promise.allSettled(batchPromises);
                    
                    // Longer delay between batches to prevent system overload
                    if (i + batchSize < urls.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Increased to 1s
                        
                        // Memory cleanup between batches
                        if (window.gc) window.gc(); // Force garbage collection if available
                    }
                }
                
                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Bulk scan completed in ${totalTime}s`);
                showNotification(`Scan completed! ${urls.length} URLs processed in ${totalTime}s`, 'success');
                
            } catch (error) {
                console.error('Bulk scan error:', error);
                showNotification('Bulk scan encountered errors. Check individual results.', 'warning');
            } finally {
                // Re-enable scan button
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<span style="margin-right: 8px;">üöÄ</span> Start Bulk Scan';
            }
        }
        
        // Resource-conscious scanning function
        async function scanSingleUrlOptimized(url) {
            const cardId = `card-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const card = createResultCard(url, 'scanning', cardId);
            document.getElementById('results-grid').appendChild(card);
            
            const startTime = Date.now();
            let scanResponse, resultResponse; // Declare for cleanup
            
            try {
                // Step 1: Initiate scan with shorter timeout to prevent hanging
                scanResponse = await Promise.race([
                    fetch('http://localhost:8000/api/scan/scan', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Connection': 'close' // Prevent connection pooling issues
                        },
                        body: JSON.stringify({ url, user_email: null })
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Scan initiation timeout')), 3000) // Reduced to 3s
                    )
                ]);
                
                if (!scanResponse.ok) {
                    throw new Error(`HTTP ${scanResponse.status}: ${scanResponse.statusText}`);
                }
                
                const scanData = await scanResponse.json();
                const scanId = scanData.scan_id;
                
                // Step 2: Conservative polling to prevent resource exhaustion
                let attempts = 0;
                let pollInterval = 1000; // Start with 1s (slower but more stable)
                const maxAttempts = 15; // Reduced max attempts
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                    
                    try {
                        resultResponse = await Promise.race([
                            fetch(`http://localhost:8000/api/scan/scan/${scanId}`, {
                                headers: { 'Connection': 'close' }
                            }),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Result fetch timeout')), 2000) // Reduced to 2s
                            )
                        ]);
                        
                        if (!resultResponse.ok) {
                            throw new Error(`HTTP ${resultResponse.status}`);
                        }
                        
                        const result = await resultResponse.json();
                        
                        if (result.status === 'completed' && result.results) {
                            const scanTime = ((Date.now() - startTime) / 1000).toFixed(1);
                            const isThreat = result.results.is_malicious;
                            
                            updateResultCard(cardId, url, isThreat ? 'threat' : 'safe', result.results, scanTime);
                            
                            scanResults.push({ 
                                url, 
                                result: result.results, 
                                scanTime: scanTime,
                                timestamp: new Date().toISOString()
                            });
                            
                            scannedUrls++;
                            if (isThreat) threatUrls++;
                            else safeUrls++;
                            updateStats();
                            
                            console.log(`‚úÖ ${url} scanned in ${scanTime}s - ${isThreat ? 'THREAT' : 'SAFE'}`);
                            updatePerformanceStats(scanTime, true);
                            return;
                        }
                        
                        // Conservative backoff: increase interval but cap at 3 seconds
                        pollInterval = Math.min(pollInterval * 1.1, 3000); // Slower increase
                        attempts++;
                        
                        // Memory cleanup during polling
                        if (attempts % 5 === 0 && window.gc) {
                            window.gc();
                        }
                        
                    } catch (pollError) {
                        console.warn(`Poll attempt ${attempts + 1} failed for ${url}:`, pollError.message);
                        attempts++;
                        pollInterval = Math.min(pollInterval * 1.3, 3000);
                        
                        // Cleanup failed responses
                        if (resultResponse && resultResponse.body) {
                            try { resultResponse.body.cancel(); } catch (e) {}
                        }
                    }
                }
                
                // Timeout - mark as incomplete
                throw new Error(`Scan timeout after ${maxAttempts} attempts`);
                
            } catch (error) {
                const scanTime = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error(`‚ùå ${url} failed in ${scanTime}s:`, error.message);
                
                updateResultCard(cardId, url, 'error', { 
                    error: error.message,
                    scanTime: scanTime
                });
                
                scannedUrls++;
                updateStats();
                updatePerformanceStats(scanTime, false);
            } finally {
                // Cleanup resources
                if (scanResponse && scanResponse.body) {
                    try { scanResponse.body.cancel(); } catch (e) {}
                }
                if (resultResponse && resultResponse.body) {
                    try { resultResponse.body.cancel(); } catch (e) {}
                }
            }
        }
        
        // Legacy function for compatibility
        async function scanSingleUrl(url) {
            return scanSingleUrlOptimized(url);
        }
        
        function createResultCard(url, status, id) {
            const card = document.createElement('div');
            card.className = `result-card ${status}`;
            card.id = id;
            card.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">
                    ${status === 'scanning' ? '‚è≥' : status === 'safe' ? '‚úÖ' : '‚ö†Ô∏è'}
                </div>
                <div style="font-weight: bold; margin-bottom: 10px; word-break: break-all;">
                    ${url}
                </div>
                <div style="color: rgba(255, 255, 255, 0.7);">
                    ${status === 'scanning' ? 'Scanning...' : 'Processing...'}
                </div>
            `;
            return card;
        }
        
        function updateResultCard(cardId, url, status, result, scanTime = null) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            card.className = `result-card ${status}`;
            
            let statusIcon, statusText, statusColor, detailsHtml = '';
            
            switch (status) {
                case 'safe':
                    statusIcon = '‚úÖ';
                    statusText = 'Safe';
                    statusColor = '#4CAF50';
                    detailsHtml = `
                        <div style="background: rgba(76, 175, 80, 0.2); padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 10px;">
                            <div>‚úì ${result.total_engines || 0} engines checked</div>
                            <div>‚úì SSL: ${result.ssl_valid ? 'Valid' : 'Invalid'}</div>
                            ${result.detection_details?.ml_analysis?.ml_confidence ? 
                                `<div>‚úì ML Confidence: ${Math.round(result.detection_details.ml_analysis.ml_confidence * 100)}%</div>` : ''}
                        </div>
                    `;
                    break;
                case 'threat':
                    statusIcon = '‚ö†Ô∏è';
                    statusText = `${result.threat_level?.toUpperCase() || 'UNKNOWN'} THREAT`;
                    statusColor = result.threat_level === 'high' ? '#F44336' : '#FF9800';
                    detailsHtml = `
                        <div style="background: rgba(244, 67, 54, 0.2); padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 10px;">
                            <div>‚ö†Ô∏è ${result.malicious_count || 0}/${result.total_engines || 0} engines flagged</div>
                            <div>‚ö†Ô∏è ${result.suspicious_count || 0} suspicious detections</div>
                            ${result.detection_details?.url_analysis?.suspicious_score ? 
                                `<div>‚ö†Ô∏è Suspicious Score: ${result.detection_details.url_analysis.suspicious_score}</div>` : ''}
                        </div>
                    `;
                    break;
                case 'error':
                    statusIcon = '‚ùå';
                    statusText = 'Scan Failed';
                    statusColor = '#9E9E9E';
                    detailsHtml = `
                        <div style="background: rgba(158, 158, 158, 0.2); padding: 10px; border-radius: 8px; font-size: 12px; margin-top: 10px;">
                            <div>‚ùå ${result.error || 'Unknown error'}</div>
                            ${result.scanTime ? `<div>‚è±Ô∏è Failed after ${result.scanTime}s</div>` : ''}
                        </div>
                    `;
                    break;
            }
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <div style="font-size: 24px;">${statusIcon}</div>
                    ${scanTime ? `<div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">‚è±Ô∏è ${scanTime}s</div>` : ''}
                </div>
                <div style="font-weight: bold; margin-bottom: 10px; word-break: break-all; font-size: 14px;">
                    ${url}
                </div>
                <div style="color: ${statusColor}; font-weight: 600; margin-bottom: 10px; font-size: 13px;">
                    ${statusText}
                </div>
                ${detailsHtml}
                ${status !== 'error' ? `
                    <div style="margin-top: 15px;">
                        <button onclick="viewDetailedReport('${url}', '${cardId}')" 
                                style="background: linear-gradient(135deg, hsl(220 90% 56%), hsl(220 85% 60%)); 
                                       color: white; border: none; padding: 8px 16px; border-radius: 6px; 
                                       font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                            üìä View Details
                        </button>
                    </div>
                ` : ''}
            `;
        }
        
        // Function to view detailed report
        function viewDetailedReport(url, cardId) {
            const result = scanResults.find(r => r.url === url);
            if (!result) {
                showNotification('Report data not found', 'error');
                return;
            }
            
            // Create a modal or new window with detailed report
            const reportWindow = window.open('', '_blank', 'width=800,height=600');
            reportWindow.document.write(`
                <html>
                <head>
                    <title>Detailed Report - ${url}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                        .header { border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
                        .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
                        .safe { background: #e8f5e8; border-left: 4px solid #4CAF50; }
                        .threat { background: #ffeaea; border-left: 4px solid #F44336; }
                        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
                        .detail-card { background: #f9f9f9; padding: 15px; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>üõ°Ô∏è WebShield Detailed Report</h1>
                            <p><strong>URL:</strong> ${url}</p>
                            <p><strong>Scan Time:</strong> ${result.scanTime}s</p>
                            <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                        </div>
                        
                        <div class="status ${result.result.is_malicious ? 'threat' : 'safe'}">
                            <h2>${result.result.is_malicious ? '‚ö†Ô∏è THREAT DETECTED' : '‚úÖ SAFE'}</h2>
                            <p>Threat Level: ${result.result.threat_level || 'unknown'}</p>
                        </div>
                        
                        <div class="detail-grid">
                            <div class="detail-card">
                                <h3>Detection Summary</h3>
                                <p>Malicious: ${result.result.malicious_count || 0}</p>
                                <p>Suspicious: ${result.result.suspicious_count || 0}</p>
                                <p>Total Engines: ${result.result.total_engines || 0}</p>
                                <p>SSL Valid: ${result.result.ssl_valid ? 'Yes' : 'No'}</p>
                            </div>
                            
                            <div class="detail-card">
                                <h3>Technical Details</h3>
                                <p>Domain Reputation: ${result.result.domain_reputation || 'unknown'}</p>
                                ${result.result.detection_details?.ml_analysis ? 
                                    `<p>ML Confidence: ${Math.round(result.result.detection_details.ml_analysis.ml_confidence * 100)}%</p>` : ''}
                                ${result.result.detection_details?.url_analysis?.suspicious_score ? 
                                    `<p>Suspicious Score: ${result.result.detection_details.url_analysis.suspicious_score}</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center;">
                            <button onclick="window.close()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                                Close Report
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }
        
        function updateStats() {
            document.getElementById('total-urls').textContent = totalUrls;
            document.getElementById('scanned-urls').textContent = scannedUrls;
            document.getElementById('safe-urls').textContent = safeUrls;
            document.getElementById('threat-urls').textContent = threatUrls;
            
            const progress = totalUrls > 0 ? (scannedUrls / totalUrls) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }
        
        function clearAll() {
            // Clear UI
            document.getElementById('url-input').value = '';
            document.getElementById('results-grid').innerHTML = '';
            document.getElementById('progress-section').style.display = 'none';
            
            // Reset all variables to prevent memory leaks
            scanResults = [];
            totalUrls = 0;
            scannedUrls = 0;
            safeUrls = 0;
            threatUrls = 0;
            
            // Reset performance stats
            performanceStats = {
                totalScans: 0,
                totalTime: 0,
                averageTime: 0,
                successRate: 0,
                errors: 0
            };
            
            // Force garbage collection if available
            if (window.gc) {
                window.gc();
            }
            
            showNotification('All data cleared and memory cleaned', 'info');
        }
        
        function exportResults() {
            if (scanResults.length === 0) {
                showNotification('No results to export', 'error');
                return;
            }
            
            // Create comprehensive CSV with all details
            let csv = 'URL,Status,Threat Level,Scan Time (s),Malicious Count,Suspicious Count,Total Engines,SSL Valid,Domain Reputation,ML Confidence,Suspicious Score,Timestamp\n';
            
            scanResults.forEach(item => {
                const result = item.result;
                const status = result.is_malicious ? 'Threat' : 'Safe';
                const threatLevel = result.threat_level || 'unknown';
                const scanTime = item.scanTime || 'N/A';
                const malicious = result.malicious_count || 0;
                const suspicious = result.suspicious_count || 0;
                const total = result.total_engines || 0;
                const sslValid = result.ssl_valid ? 'Yes' : 'No';
                const domainRep = result.domain_reputation || 'unknown';
                const mlConfidence = result.detection_details?.ml_analysis?.ml_confidence ? 
                    Math.round(result.detection_details.ml_analysis.ml_confidence * 100) + '%' : 'N/A';
                const suspiciousScore = result.detection_details?.url_analysis?.suspicious_score || 'N/A';
                const timestamp = item.timestamp || new Date().toISOString();
                
                csv += `"${item.url}","${status}","${threatLevel}","${scanTime}",${malicious},${suspicious},${total},"${sslValid}","${domainRep}","${mlConfidence}","${suspiciousScore}","${timestamp}"\n`;
            });
            
            // Download with timestamp
            const now = new Date();
            const filename = `webshield-bulk-scan-${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.csv`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Exported ${scanResults.length} results to ${filename}`, 'success');
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #4CAF50, #45a049)' : 
                           type === 'error' ? 'linear-gradient(135deg, #F44336, #d32f2f)' : 
                           type === 'warning' ? 'linear-gradient(135deg, #FF9800, #f57c00)' : 
                           'linear-gradient(135deg, #2196F3, #1976d2)'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .btn-scan:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none !important;
            }
        `;
        document.head.appendChild(style);
        
        // Load sample URLs for testing
        function loadSampleUrls() {
            const sampleUrls = [
                'https://google.com',
                'https://github.com',
                'https://stackoverflow.com',
                'https://microsoft.com',
                'https://amazon.com',
                'https://facebook.com',
                'https://twitter.com',
                'https://linkedin.com',
                'https://youtube.com',
                'https://wikipedia.org',
                'https://reddit.com',
                'https://apple.com',
                'https://netflix.com',
                'https://instagram.com',
                'https://whatsapp.com'
            ];
            
            document.getElementById('url-input').value = sampleUrls.join('\n');
            showNotification(`Loaded ${sampleUrls.length} sample URLs for testing`, 'info');
        }
        
        // Performance monitoring
        let performanceStats = {
            totalScans: 0,
            totalTime: 0,
            averageTime: 0,
            successRate: 0,
            errors: 0
        };
        
        function updatePerformanceStats(scanTime, success) {
            performanceStats.totalScans++;
            if (success) {
                performanceStats.totalTime += parseFloat(scanTime);
                performanceStats.averageTime = (performanceStats.totalTime / (performanceStats.totalScans - performanceStats.errors)).toFixed(2);
            } else {
                performanceStats.errors++;
            }
            performanceStats.successRate = (((performanceStats.totalScans - performanceStats.errors) / performanceStats.totalScans) * 100).toFixed(1);
            
            // Update performance display if exists
            const perfDisplay = document.getElementById('performance-stats');
            if (perfDisplay) {
                perfDisplay.innerHTML = `
                    <div style="display: flex; gap: 20px; justify-content: center; font-size: 12px; color: rgba(255,255,255,0.7);">
                        <span>Avg: ${performanceStats.averageTime}s</span>
                        <span>Success: ${performanceStats.successRate}%</span>
                        <span>Total: ${performanceStats.totalScans}</span>
                    </div>
                `;
            }
        }
        
        // Add performance display
        document.addEventListener('DOMContentLoaded', () => {
            const progressSection = document.getElementById('progress-section');
            if (progressSection) {
                const perfDiv = document.createElement('div');
                perfDiv.id = 'performance-stats';
                perfDiv.style.cssText = 'margin-top: 20px; text-align: center;';
                progressSection.appendChild(perfDiv);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                startBulkScan();
            }
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                loadSampleUrls();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportResults();
            }
        });
        
        // Add keyboard shortcuts info
        const shortcutsInfo = document.createElement('div');
        shortcutsInfo.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        `;
        shortcutsInfo.innerHTML = `
            <div><strong>Keyboard Shortcuts:</strong></div>
            <div>Ctrl+Enter: Start Scan</div>
            <div>Ctrl+L: Load Samples</div>
            <div>Ctrl+E: Export Results</div>
        `;
        document.body.appendChild(shortcutsInfo);
        
        console.log('üöÄ WebShield Bulk Scanner v2.0 - Optimized for speed and efficiency!');
    </script>
</body>
</html>
